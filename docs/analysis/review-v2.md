# å¤©æ¸…å¯¹åˆ†æå¸ˆv2æ–¹æ¡ˆçš„è¯¦ç»†å®¡æ ¸æŠ¥å‘Š

**å®¡æ ¸æ—¥æœŸ**ï¼š2026-02-27  
**å®¡æ ¸è€…**ï¼šå¤©æ¸…ï¼ˆmain agent, glm-5ï¼‰  
**è¢«å®¡æ ¸æ–¹æ¡ˆ**ï¼šanalyst-agent v2 åˆ†ææŠ¥å‘Š

---

## å®¡æ ¸æ–¹æ³•

**å¤©æ¸…é‡‡ç”¨æ‰¹åˆ¤æ€§æ€ç»´ï¼š**
1. âœ… å…ˆè‚¯å®šåšå¾—å¥½çš„åœ°æ–¹
2. âŒ æ‰¾å‡ºé—®é¢˜å’Œæ¼æ´
3. âš ï¸ æå‡ºæ”¹è¿›å»ºè®®
4. ğŸ’¡ ç»™å‡ºå…·ä½“æ–¹æ¡ˆ

---

## ä¸€ã€éœ€æ±‚ç¡®è®¤å®¡æ ¸

### âœ… åšå¾—å¥½çš„åœ°æ–¹

1. **è¡¥å……äº†é—æ¼çš„åŠŸèƒ½**ï¼š
   - âœ… å¹¶å‘é™åˆ¶ï¼ˆNF-PERF-01ï¼‰
   - âœ… å†å²æ•°æ®ä¿ç•™ï¼ˆF-A2A-HISTORYï¼‰
   - âœ… é”™è¯¯æ¢å¤æœºåˆ¶ï¼ˆNF-RELIABILITY-01/02/03ï¼‰
   - âœ… å¤šç§Ÿæˆ·æ”¯æŒï¼ˆNF-MULTI-TENANT-01ï¼‰

2. **å¢åŠ äº†è¾¹ç•Œæ¡ä»¶**ï¼š
   - âœ… Agentæ•°é‡ä¸Šé™
   - âœ… Sessionæ—¥å¿—å¤§å°é™åˆ¶
   - âœ… åˆ·æ–°é¢‘ç‡é™åˆ¶

3. **è€ƒè™‘äº†é”™è¯¯å¤„ç†**ï¼š
   - âœ… OpenClawæœªè¿è¡Œæ£€æµ‹
   - âœ… é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯

### âŒ å­˜åœ¨çš„é—®é¢˜

#### é—®é¢˜1ï¼šæ€§èƒ½æŒ‡æ ‡ç¼ºä¹ä¾æ®

**åˆ†æå¸ˆè¯´ï¼š**
- æ”¯æŒ10ä¸ªAgentåŒæ—¶è¿è¡Œ
- APIå“åº”< 2ç§’
- å†…å­˜å ç”¨< 500MB

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ 10ä¸ªAgentçš„ä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸æ˜¯20ä¸ªï¼Ÿ
- â“ 2ç§’å“åº”æ—¶é—´çš„ä¾æ®ï¼Ÿæœ‰åšè¿‡åŸºå‡†æµ‹è¯•å—ï¼Ÿ
- â“ 500MBå†…å­˜çš„ä¾æ®ï¼Ÿå¤§Sessionæ–‡ä»¶æ€ä¹ˆåŠï¼Ÿ

**é£é™©è¯„ä¼°ï¼šé«˜** - å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸è¾¾æ ‡

**æ”¹è¿›å»ºè®®ï¼š**
```typescript
NF-PERF-01: å¹¶å‘æ€§èƒ½ä¿è¯ï¼ˆéœ€éªŒè¯ï¼‰
éªŒæ”¶æ ‡å‡†:
- æ”¯æŒ 10 ä¸ª Agent åŒæ—¶è¿è¡Œï¼ˆåŸºäºå½“å‰ç”¨æˆ·é…ç½®ï¼Œåç»­å‹åŠ›æµ‹è¯•éªŒè¯ï¼‰
- æ”¯æŒ 3-5 ä¸ªç”¨æˆ·åŒæ—¶è®¿é—® Dashboardï¼ˆé¢„ä¼°ï¼Œéœ€å®é™…æµ‹è¯•ï¼‰
- å•æ¬¡ API å“åº”æ—¶é—´ < 2ç§’ï¼ˆç›®æ ‡ï¼Œéœ€æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼‰
- å†…å­˜å ç”¨ < 500MBï¼ˆç›®æ ‡ï¼Œéœ€å®é™…ç›‘æ§ï¼‰

æ€§èƒ½åŸºå‡†æµ‹è¯•è®¡åˆ’ï¼š
- æ¨¡æ‹Ÿ 5/10/20 ä¸ª Agent åœºæ™¯
- æ¨¡æ‹Ÿ 1/3/5/10 ä¸ªå¹¶å‘ç”¨æˆ·
- æµ‹è¯•ä¸åŒ Session æ–‡ä»¶å¤§å°ï¼ˆ1MB/10MB/50MBï¼‰
```

---

#### é—®é¢˜2ï¼šå†å²æ•°æ®ä¿ç•™æœŸä¸å¤Ÿæ¸…æ™°

**åˆ†æå¸ˆè¯´ï¼š**
- ä¿ç•™30å¤©
- æœ€å¤š1000æ¡

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ 30å¤©çš„ä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿç”¨æˆ·éœ€è¦çœ‹å¤šä¹…çš„å†å²ï¼Ÿ
- â“ 1000æ¡çš„ä¾æ®ï¼Ÿå¦‚æœä¸€å¤©æœ‰100ä¸ªä»»åŠ¡æ€ä¹ˆåŠï¼Ÿ
- â“ æ²¡æœ‰è€ƒè™‘å­˜å‚¨ç©ºé—´é—®é¢˜

**é£é™©è¯„ä¼°ï¼šä¸­** - å¯èƒ½å¯¼è‡´å­˜å‚¨ç©ºé—´ä¸è¶³æˆ–æ•°æ®ä¸¢å¤±

**æ”¹è¿›å»ºè®®ï¼š**
```typescript
F-A2A-HISTORY: ä»»åŠ¡å†å²æ•°æ®ä¿ç•™ï¼ˆéœ€ç”¨æˆ·ç¡®è®¤ï¼‰
éªŒæ”¶æ ‡å‡†:
- å®Œæˆçš„ä»»åŠ¡ä¿ç•™ N å¤©ï¼ˆéœ€ç¡®è®¤ï¼š7å¤©/30å¤©/90å¤©ï¼Ÿï¼‰
- æœ€å¤šä¿ç•™ M æ¡å†å²ä»»åŠ¡ï¼ˆéœ€ç¡®è®¤ï¼š500/1000/5000ï¼Ÿï¼‰
- å­˜å‚¨ç©ºé—´é™åˆ¶ï¼š< 100MBï¼ˆéœ€ç›‘æ§ï¼‰

æ•°æ®ä¿ç•™ç­–ç•¥ï¼ˆéœ€ç”¨æˆ·ç¡®è®¤ï¼‰ï¼š
- æ–¹æ¡ˆAï¼š30å¤© + 1000æ¡ï¼ˆä¿å®ˆï¼‰
- æ–¹æ¡ˆBï¼š90å¤© + 5000æ¡ï¼ˆæ¿€è¿›ï¼Œå­˜å‚¨å¯èƒ½çˆ†ï¼‰
- æ–¹æ¡ˆCï¼š30å¤© + æ— æ¡æ•°é™åˆ¶ï¼ˆæŠ˜ä¸­ï¼‰

æ¸…ç†ç­–ç•¥ï¼š
- æ¯æ—¥å‡Œæ™¨æ¸…ç†è¿‡æœŸæ•°æ®
- ç›‘æ§ SQLite æ–‡ä»¶å¤§å°ï¼Œè¶…è¿‡é˜ˆå€¼å‘Šè­¦
```

---

#### é—®é¢˜3ï¼šé”™è¯¯æ¢å¤æœºåˆ¶ä¸å®Œæ•´

**åˆ†æå¸ˆè¯´ï¼š**
- WebSocketæ–­çº¿é‡è¿
- åç«¯æŒ‚æ‰é™çº§

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ æ²¡æœ‰è€ƒè™‘watchdogå¤±æ•ˆçš„æƒ…å†µ
- â“ æ²¡æœ‰è€ƒè™‘SQLiteæŸåçš„æƒ…å†µ
- â“ æ²¡æœ‰è€ƒè™‘ç£ç›˜ç©ºé—´æ»¡çš„æƒ…å†µ
- â“ æ²¡æœ‰è€ƒè™‘æƒé™é—®é¢˜

**é£é™©è¯„ä¼°ï¼šé«˜** - å¯èƒ½å¯¼è‡´ç³»ç»Ÿä¸å¯ç”¨

**æ”¹è¿›å»ºè®®ï¼š**
```typescript
NF-RELIABILITY-04: æ–‡ä»¶ç›‘å¬å¤±æ•ˆé™çº§
éªŒæ”¶æ ‡å‡†:
- watchdog è¿›ç¨‹å¼‚å¸¸é€€å‡º â†’ è‡ªåŠ¨é‡å¯ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- ç›‘å¬å¤±æ•ˆè¶…è¿‡5åˆ†é’Ÿ â†’ é™çº§åˆ°å®šæ—¶è½®è¯¢ï¼ˆ1åˆ†é’Ÿé—´éš”ï¼‰
- æ˜¾ç¤º "å®æ—¶æ›´æ–°å·²æš‚åœï¼Œæ­£åœ¨ä½¿ç”¨å®šæ—¶åˆ·æ–°" æç¤º

NF-RELIABILITY-05: æ•°æ®åº“æŸåæ¢å¤
éªŒæ”¶æ ‡å‡†:
- SQLite æŸå â†’ é‡å»ºæ•°æ®åº“ + é‡æ–°è§£ææ–‡ä»¶
- æ˜¾ç¤º "æ•°æ®åº“å·²é‡å»ºï¼Œæ­£åœ¨é‡æ–°åŠ è½½æ•°æ®" æç¤º
- ä¿ç•™æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„å¤‡ä»½ï¼ˆ.bakæ–‡ä»¶ï¼‰

NF-RELIABILITY-06: ç£ç›˜ç©ºé—´ç®¡ç†
éªŒæ”¶æ ‡å‡†:
- ç£ç›˜ç©ºé—´ < 100MB â†’ åœæ­¢å†™å…¥ç¼“å­˜ï¼Œå‘Šè­¦
- æ˜¾ç¤º "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œç¼“å­˜å·²æš‚åœ" æç¤º
- æä¾›æ¸…ç†å†å²æ•°æ®çš„åŠŸèƒ½

NF-RELIABILITY-07: æƒé™é—®é¢˜å¤„ç†
éªŒæ”¶æ ‡å‡†:
- æ–‡ä»¶è¯»å–æƒé™ä¸è¶³ â†’ æ˜¾ç¤ºé”™è¯¯è¯¦æƒ… + æƒé™ä¿®å¤å»ºè®®
- SQLite å†™å…¥æƒé™ä¸è¶³ â†’ é™çº§åˆ°åªè¯»æ¨¡å¼
```

---

### âš ï¸ é—æ¼çš„é‡è¦éœ€æ±‚

#### é—æ¼1ï¼šæ€§èƒ½ç›‘æ§

**å¤©æ¸…è®¤ä¸ºå¿…é¡»æœ‰ï¼š**
- âœ… APIå“åº”æ—¶é—´ç›‘æ§
- âœ… å†…å­˜ä½¿ç”¨ç›‘æ§
- âœ… SQLiteå¤§å°ç›‘æ§
- âœ… watchdogçŠ¶æ€ç›‘æ§

```typescript
NF-MONITOR-01: ç³»ç»Ÿæ€§èƒ½ç›‘æ§
éªŒæ”¶æ ‡å‡†:
- Dashboard æ˜¾ç¤ºåç«¯å¥åº·çŠ¶æ€ï¼ˆCPU/å†…å­˜/ç£ç›˜ï¼‰
- API å“åº”æ—¶é—´ç»Ÿè®¡ï¼ˆP50/P95/P99ï¼‰
- WebSocket è¿æ¥æ•°ç›‘æ§
- SQLite ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
```

---

#### é—æ¼2ï¼šæ•°æ®è¿ç§»å’Œå›æ»š

**å¤©æ¸…è®¤ä¸ºå¿…é¡»æœ‰ï¼š**
- âœ… SQLite schemaå˜æ›´ç­–ç•¥
- âœ… æ•°æ®è¿ç§»æ–¹æ¡ˆ
- âœ… å›æ»šæœºåˆ¶

```typescript
NF-MIGRATION-01: æ•°æ®åº“è¿ç§»ç­–ç•¥
éªŒæ”¶æ ‡å‡†:
- SQLite schema ç‰ˆæœ¬ç®¡ç†
- è‡ªåŠ¨è¿ç§»è„šæœ¬ï¼ˆv1 â†’ v2 â†’ v3ï¼‰
- è¿ç§»å¤±è´¥è‡ªåŠ¨å›æ»š
- å¤‡ä»½è¿ç§»å‰çš„æ•°æ®
```

---

## äºŒã€æ•°æ®æºå¯è¡Œæ€§å®¡æ ¸

### âœ… åšå¾—å¥½çš„åœ°æ–¹

1. **åŒå±‚æ¶æ„è®¾è®¡åˆç†**ï¼š
   - âœ… runs.json + task_history.db
   - âœ… è‡ªåŠ¨å¤‡ä»½æœºåˆ¶
   - âœ… å®šæœŸæ¸…ç†

2. **SQLiteç¼“å­˜æ–¹æ¡ˆè¯¦ç»†**ï¼š
   - âœ… session_cacheè¡¨è®¾è®¡
   - âœ… task_historyè¡¨è®¾è®¡
   - âœ… å¢é‡æ›´æ–°é€»è¾‘

3. **ä»£ç ç¤ºä¾‹æ¸…æ™°**ï¼š
   - âœ… TaskHistoryServiceå®ç°
   - âœ… RunsJsonHandlerç›‘å¬
   - âœ… jsonl_readerè§£æ

### âŒ å­˜åœ¨çš„é—®é¢˜

#### é—®é¢˜1ï¼šruns.jsonå¤‡ä»½æ—¶æœºä¸æ˜ç¡®

**åˆ†æå¸ˆè¯´ï¼š**
- watchdogç›‘å¬runs.jsonå˜åŒ–
- è‡ªåŠ¨å¤‡ä»½åˆ°task_history.db

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ å¦‚æœruns.jsonåœ¨watchdogç›‘å¬ä¹‹å‰å°±å˜äº†æ€ä¹ˆåŠï¼Ÿ
- â“ å¦‚æœOpenClawæ¸…ç©ºruns.jsonå¤ªå¿«ï¼Œwatchdogæ²¡æ¥å¾—åŠæ•è·æ€ä¹ˆåŠï¼Ÿ
- â“ æ²¡æœ‰è€ƒè™‘æ—¶åºé—®é¢˜

**é£é™©è¯„ä¼°ï¼šé«˜** - å¯èƒ½å¯¼è‡´ä»»åŠ¡å†å²ä¸¢å¤±

**æ”¹è¿›å»ºè®®ï¼š**
```python
# å¢åŠ "å…œåº•æ‰«æ"æœºåˆ¶
class TaskHistoryService:
    def __init__(self):
        self.last_scan_time = 0
        self.backup_interval = 60  # æ¯åˆ†é’Ÿæ‰«æä¸€æ¬¡
    
    def periodic_backup(self):
        """å®šæ—¶æ‰«æï¼ˆå…œåº•æœºåˆ¶ï¼‰"""
        current_time = time.time()
        if current_time - self.last_scan_time > self.backup_interval:
            logger.info("Periodic backup scan started")
            self.backup_from_runs_json()
            self.last_scan_time = current_time

# å¯åŠ¨å®šæ—¶å™¨
import threading
def start_periodic_backup():
    service = TaskHistoryService()
    timer = threading.Timer(60.0, start_periodic_backup)
    timer.daemon = True
    timer.start()
    service.periodic_backup()
```

**åŒé‡ä¿éšœï¼š**
1. watchdogå®æ—¶ç›‘å¬ï¼ˆä¸»è¦ï¼‰
2. å®šæ—¶æ‰«æå¤‡ä»½ï¼ˆå…œåº•ï¼‰

---

#### é—®é¢˜2ï¼šSQLiteå¹¶å‘æ€§èƒ½æœªéªŒè¯

**åˆ†æå¸ˆè¯´ï¼š**
- ä½¿ç”¨WALæ¨¡å¼
- è¯»å†™åˆ†ç¦»

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ WALæ¨¡å¼åœ¨é«˜å¹¶å‘å†™å…¥æ—¶çš„æ€§èƒ½å¦‚ä½•ï¼Ÿ
- â“ å¤šä¸ªwatchdogäº‹ä»¶åŒæ—¶è§¦å‘å†™å…¥SQLiteï¼Œä¼šä¸ä¼šé”å†²çªï¼Ÿ
- â“ æœ‰æ²¡æœ‰åšè¿‡åŸºå‡†æµ‹è¯•ï¼Ÿ

**é£é™©è¯„ä¼°ï¼šä¸­** - å¯èƒ½å¯¼è‡´å†™å…¥é˜»å¡

**æ”¹è¿›å»ºè®®ï¼š**
```python
# å¢åŠ å†™å…¥é˜Ÿåˆ—
import queue
import threading

class SQLiteWriterQueue:
    def __init__(self, db_path: str):
        self.db_path = db_path
        self.write_queue = queue.Queue()
        self.worker_thread = threading.Thread(target=self._worker, daemon=True)
        self.worker_thread.start()
    
    def _worker(self):
        """åå°çº¿ç¨‹å¤„ç†å†™å…¥è¯·æ±‚"""
        conn = sqlite3.connect(self.db_path)
        while True:
            try:
                sql, params = self.write_queue.get()
                conn.execute(sql, params)
                conn.commit()
            except Exception as e:
                logger.error(f"SQLite write error: {e}")
    
    def enqueue_write(self, sql: str, params: tuple):
        """å°†å†™å…¥è¯·æ±‚åŠ å…¥é˜Ÿåˆ—"""
        self.write_queue.put((sql, params))

# ä½¿ç”¨ç¤ºä¾‹
writer_queue = SQLiteWriterQueue('dashboard.db')
writer_queue.enqueue_write(
    "INSERT INTO task_history (...) VALUES (?, ?, ...)",
    (run_id, agent_id, ...)
)
```

**æ€§èƒ½åŸºå‡†æµ‹è¯•è®¡åˆ’ï¼š**
```python
# æµ‹è¯•SQLiteå¹¶å‘å†™å…¥æ€§èƒ½
def benchmark_sqlite_concurrent_writes():
    # æ¨¡æ‹Ÿ 10 ä¸ªå¹¶å‘å†™å…¥
    # æµ‹è¯• WAL æ¨¡å¼ vs é»˜è®¤æ¨¡å¼
    # æµ‹è¯•å†™å…¥é˜Ÿåˆ— vs ç›´æ¥å†™å…¥
    # ç›®æ ‡ï¼š< 100ms å»¶è¿Ÿ
```

---

#### é—®é¢˜3ï¼šå¢é‡è¯»å–çš„last_positionå¯èƒ½ä¸æ­£ç¡®

**åˆ†æå¸ˆè¯´ï¼š**
- ä»last_positionå¼€å§‹è¯»å–
- å¢é‡æ›´æ–°

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ å¦‚æœæ–‡ä»¶è¢«æˆªæ–­æˆ–rotateäº†æ€ä¹ˆåŠï¼Ÿ
- â“ last_positionå¯èƒ½æŒ‡å‘é”™è¯¯çš„ä½ç½®
- â“ æ²¡æœ‰è€ƒè™‘æ–‡ä»¶å¤§å°å˜åŒ–

**é£é™©è¯„ä¼°ï¼šä¸­** - å¯èƒ½å¯¼è‡´æ•°æ®è§£æé”™è¯¯

**æ”¹è¿›å»ºè®®ï¼š**
```python
def update_session_incremental(self, agent_id: str, session_file: str):
    """å¢é‡æ›´æ–° session ç¼“å­˜ï¼ˆå¸¦å®Œæ•´æ€§æ£€æŸ¥ï¼‰"""
    current_size = os.path.getsize(session_file)
    
    # 1. è·å–ä¸Šæ¬¡è¯»å–ä½ç½®
    cursor = self.conn.cursor()
    cursor.execute(
        "SELECT last_position, last_modified FROM session_cache WHERE file_path = ?",
        (session_file,)
    )
    row = cursor.fetchone()
    
    if row:
        last_position, last_modified = row
        
        # 2. å®Œæ•´æ€§æ£€æŸ¥ï¼šæ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹æˆ–æˆªæ–­ï¼Ÿ
        if current_size < last_position:
            # æ–‡ä»¶è¢«æˆªæ–­æˆ–rotateï¼Œé‡æ–°å…¨é‡è¯»å–
            logger.warning(f"File {session_file} was truncated, re-reading from start")
            last_position = 0
        elif int(os.path.getmtime(session_file) * 1000) < last_modified:
            # æ–‡ä»¶æœªä¿®æ”¹ï¼Œè·³è¿‡
            return
    else:
        last_position = 0
    
    # 3. å¢é‡è¯»å–
    new_events = parse_jsonl_incremental(session_file, last_position)
    
    # 4. è§£æå¹¶ç¼“å­˜
    for event in new_events:
        self._cache_event(cursor, event)
    
    # 5. æ›´æ–° last_position
    cursor.execute("""
        INSERT OR REPLACE INTO session_cache 
        (file_path, last_position, last_modified)
        VALUES (?, ?, ?)
    """, (session_file, current_size, int(time.time() * 1000)))
    
    self.conn.commit()
```

---

## ä¸‰ã€æŠ€æœ¯æ¶æ„å®¡æ ¸

### âœ… åšå¾—å¥½çš„åœ°æ–¹

1. **ä¸‰å±‚æ¶æ„æ¸…æ™°**ï¼š
   - âœ… æ•°æ®å±‚ï¼šSQLite
   - âœ… ç›‘å¬å±‚ï¼šwatchdog
   - âœ… æ¨é€å±‚ï¼šSocket.IO

2. **ä»£ç ç¤ºä¾‹è¯¦ç»†**ï¼š
   - âœ… TaskHistoryService
   - âœ… SessionCacheService
   - âœ… æ–‡ä»¶ç›‘å¬Handler

### âŒ å­˜åœ¨çš„é—®é¢˜

#### é—®é¢˜1ï¼šwatchdogç›‘å¬å¤±æ•ˆçš„æ£€æµ‹æœºåˆ¶ç¼ºå¤±

**åˆ†æå¸ˆè¯´ï¼š**
- watchdogç›‘å¬æ–‡ä»¶å˜åŒ–
- å®æ—¶æ¨é€æ›´æ–°

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ æ€ä¹ˆçŸ¥é“watchdogæ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ
- â“ watchdogè¿›ç¨‹æŒ‚äº†æ€ä¹ˆåŠï¼Ÿ
- â“ æ²¡æœ‰å¿ƒè·³æ£€æµ‹æœºåˆ¶

**é£é™©è¯„ä¼°ï¼šé«˜** - å¯èƒ½å¯¼è‡´ç¼“å­˜ä¸æ›´æ–°

**æ”¹è¿›å»ºè®®ï¼š**
```python
# watchdogå¥åº·æ£€æŸ¥
class WatchdogHealthChecker:
    def __init__(self, check_interval: int = 60):
        self.check_interval = check_interval
        self.last_event_time = time.time()
        self.alert_threshold = 300  # 5åˆ†é’Ÿæ— äº‹ä»¶åˆ™å‘Šè­¦
    
    def record_event(self):
        """è®°å½•watchdogäº‹ä»¶"""
        self.last_event_time = time.time()
    
    def check_health(self):
        """æ£€æŸ¥watchdogå¥åº·çŠ¶æ€"""
        elapsed = time.time() - self.last_event_time
        if elapsed > self.alert_threshold:
            logger.warning(f"Watchdog inactive for {elapsed:.0f} seconds")
            # è§¦å‘å‘Šè­¦ + é™çº§åˆ°è½®è¯¢
            return False
        return True

# åœ¨Handlerä¸­è®°å½•äº‹ä»¶
class RunsJsonHandler(FileSystemEventHandler):
    def __init__(self, health_checker: WatchdogHealthChecker):
        self.health_checker = health_checker
    
    def on_modified(self, event):
        self.health_checker.record_event()  # è®°å½•äº‹ä»¶
        # ... å¤„ç†é€»è¾‘
```

---

#### é—®é¢˜2ï¼šSocket.IOæ¨é€å¯èƒ½ä¸¢å¤±

**åˆ†æå¸ˆè¯´ï¼š**
- Socket.IOæ¨é€å˜åŒ–
- å®æ—¶æ›´æ–°

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ å¦‚æœSocket.IOæ¨é€å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
- â“ å‰ç«¯æ–­çº¿é‡è¿åï¼Œå¦‚ä½•è·å–é”™è¿‡çš„æ•°æ®ï¼Ÿ
- â“ æ²¡æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶

**é£é™©è¯„ä¼°ï¼šä¸­** - å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±

**æ”¹è¿›å»ºè®®ï¼š**
```typescript
// å‰ç«¯ï¼šæ–­çº¿é‡è¿ååŒæ­¥æ•°æ®
socket.on('connect', () => {
  console.log('Socket.IO connected');
  
  // è·å–æœ€åæ”¶åˆ°çš„æ¶ˆæ¯æ—¶é—´
  const lastMessageTime = localStorage.getItem('lastMessageTime') || 0;
  
  // è¯·æ±‚åŒæ­¥é”™è¿‡çš„æ•°æ®
  socket.emit('sync', { since: lastMessageTime }, (response) => {
    console.log('Synced missed messages:', response);
    updateLocalState(response.data);
  });
});

// åç«¯ï¼šæ¶ˆæ¯ç¡®è®¤ + è¡¥å‘
@sio.on('sync')
async def handle_sync(sid, data):
    since = data.get('since', 0)
    
    # ä»SQLiteæŸ¥è¯¢é”™è¿‡çš„æ¶ˆæ¯
    missed_messages = query_messages_since(since)
    
    await sio.emit('sync_response', {
        'messages': missed_messages
    }, room=sid)
```

---

#### é—®é¢˜3ï¼šijsonæµå¼è§£æçš„æ€§èƒ½å¼€é”€æœªè¯„ä¼°

**åˆ†æå¸ˆè¯´ï¼š**
- ä½¿ç”¨ijsonæµå¼è§£æ
- å†…å­˜å‹å¥½

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ ijsonè§£æé€Ÿåº¦å¦‚ä½•ï¼Ÿæ¯”json.loadsæ…¢å¤šå°‘ï¼Ÿ
- â“ å¤§æ–‡ä»¶è§£æä¼šä¸ä¼šå¡ä½UIï¼Ÿ
- â“ æœ‰æ²¡æœ‰åšè¿‡æ€§èƒ½æµ‹è¯•ï¼Ÿ

**é£é™©è¯„ä¼°ï¼šä¸­** - å¯èƒ½å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ

**æ”¹è¿›å»ºè®®ï¼š**
```python
# æ€§èƒ½åŸºå‡†æµ‹è¯•
def benchmark_ijson_vs_json():
    """å¯¹æ¯” ijson å’Œ json çš„è§£ææ€§èƒ½"""
    import time
    import json
    import ijson
    
    # æµ‹è¯•æ–‡ä»¶ï¼š10MB sessionæ—¥å¿—
    test_file = 'test_session.jsonl'
    
    # 1. json.loads å…¨é‡è¯»å–
    start = time.time()
    with open(test_file, 'r') as f:
        data = [json.loads(line) for line in f]
    json_time = time.time() - start
    json_memory = get_memory_usage()
    
    # 2. ijson æµå¼è§£æ
    start = time.time()
    with open(test_file, 'r') as f:
        for event in ijson.items(f, ''):
            pass
    ijson_time = time.time() - start
    ijson_memory = get_memory_usage()
    
    print(f"json.loads: {json_time:.2f}s, {json_memory:.2f}MB")
    print(f"ijson: {ijson_time:.2f}s, {ijson_memory:.2f}MB")
    
    # ç›®æ ‡ï¼šijson æ—¶é—´ < json * 2ï¼Œå†…å­˜ < 50MB

# å¦‚æœ ijson å¤ªæ…¢ï¼Œè€ƒè™‘æ›¿ä»£æ–¹æ¡ˆ
# æ–¹æ¡ˆ1ï¼štail -n 1000 + json.loadsï¼ˆå¿«é€Ÿï¼Œä½†å†…å­˜ç¨é«˜ï¼‰
# æ–¹æ¡ˆ2ï¼šijsonï¼ˆå†…å­˜ä½ï¼Œä½†æ…¢ï¼‰
# æ–¹æ¡ˆ3ï¼šæ··åˆï¼ˆé¦–æ¬¡å…¨é‡ï¼Œåç»­å¢é‡ï¼‰
```

---

## å››ã€å®ç°ä¼˜å…ˆçº§å®¡æ ¸

### âœ… åšå¾—å¥½çš„åœ°æ–¹

1. **å¢åŠ äº†Phase 0**ï¼š
   - âœ… åŸºç¡€æ¶æ„ä¼˜å…ˆ
   - âœ… ç¼“å­˜å±‚ã€ç›‘å¬å±‚ã€æ¨é€å±‚

2. **æ—¶é—´ä¼°ç®—æ›´åˆç†**ï¼š
   - âœ… 11-15å¤©ï¼ˆvs ä¹‹å‰çš„21-28å¤©ï¼‰

### âŒ å­˜åœ¨çš„é—®é¢˜

#### é—®é¢˜1ï¼šPhase 0æ—¶é—´ä¼°ç®—è¿‡äºä¹è§‚

**åˆ†æå¸ˆè¯´ï¼š**
- Phase 0ï¼š2-3å¤©

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ SQLiteç¼“å­˜å±‚ + watchdogç›‘å¬ + Socket.IOæ¡†æ¶ï¼Œ2-3å¤©å¤Ÿå—ï¼Ÿ
- â“ æ²¡æœ‰è€ƒè™‘å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•æ—¶é—´
- â“ æ²¡æœ‰è€ƒè™‘è°ƒè¯•æ—¶é—´

**å¤©æ¸…çš„è¯¦ç»†ä¼°ç®—ï¼š**

```
Phase 0ï¼šåŸºç¡€æ¶æ„ï¼ˆ3-4å¤©ï¼‰

Day 1: SQLiteç¼“å­˜å±‚
- è®¾è®¡è¡¨ç»“æ„ï¼ˆ0.5å¤©ï¼‰
- å®ç°SessionCacheServiceï¼ˆ0.5å¤©ï¼‰
- å®ç°TaskHistoryServiceï¼ˆ0.5å¤©ï¼‰
- å•å…ƒæµ‹è¯•ï¼ˆ0.5å¤©ï¼‰

Day 2: watchdogç›‘å¬å±‚
- å®ç°RunsJsonHandlerï¼ˆ0.5å¤©ï¼‰
- å®ç°SessionFileHandlerï¼ˆ0.5å¤©ï¼‰
- å®ç°å¥åº·æ£€æŸ¥ï¼ˆ0.5å¤©ï¼‰
- å•å…ƒæµ‹è¯•ï¼ˆ0.5å¤©ï¼‰

Day 3: Socket.IOæ¨é€å±‚
- æ­å»ºFastAPI + Socket.IOï¼ˆ0.5å¤©ï¼‰
- å®ç°æ¶ˆæ¯æ¨é€é€»è¾‘ï¼ˆ0.5å¤©ï¼‰
- å®ç°æ–­çº¿é‡è¿ï¼ˆ0.5å¤©ï¼‰
- å•å…ƒæµ‹è¯•ï¼ˆ0.5å¤©ï¼‰

Day 4: é›†æˆæµ‹è¯•
- ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆ0.5å¤©ï¼‰
- æ€§èƒ½æµ‹è¯•ï¼ˆ0.5å¤©ï¼‰
- Bugä¿®å¤ï¼ˆ0.5å¤©ï¼‰
- æ–‡æ¡£ç¼–å†™ï¼ˆ0.5å¤©ï¼‰

æ€»è®¡ï¼š4å¤©ï¼ˆä¹è§‚ï¼š3å¤©ï¼Œæ‚²è§‚ï¼š5å¤©ï¼‰
```

**æ”¹è¿›å»ºè®®ï¼š**
- è°ƒæ•´Phase 0ä¸º3-4å¤©
- æ˜ç¡®æ¯å¤©çš„äº¤ä»˜ç‰©
- é¢„ç•™ç¼“å†²æ—¶é—´

---

#### é—®é¢˜2ï¼šPhase 1ä¾èµ–Phase 0å®Œæˆåº¦

**åˆ†æå¸ˆè¯´ï¼š**
- Phase 1åŸºäºç¼“å­˜å±‚å®ç°

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ Phase 0å¦‚æœæ²¡å®Œæˆï¼ŒPhase 1æ€ä¹ˆå¼€å§‹ï¼Ÿ
- â“ Phase 0å’ŒPhase 1çš„ä¾èµ–å…³ç³»ä¸æ¸…æ™°

**æ”¹è¿›å»ºè®®ï¼š**
```
Phase 0 éªŒæ”¶æ ‡å‡†ï¼ˆPhase 1å¼€å§‹å‰å¿…é¡»æ»¡è¶³ï¼‰ï¼š
- âœ… SQLiteç¼“å­˜å±‚å®Œæˆ + å•å…ƒæµ‹è¯•é€šè¿‡
- âœ… watchdogç›‘å¬ç¨³å®šè¿è¡Œ + å¥åº·æ£€æŸ¥é€šè¿‡
- âœ… Socket.IOæ¨é€å¯ç”¨ + æ–­çº¿é‡è¿æµ‹è¯•é€šè¿‡
- âœ… ç«¯åˆ°ç«¯æµ‹è¯•ï¼šæ–‡ä»¶å˜åŒ– â†’ ç¼“å­˜æ›´æ–° â†’ æ¨é€åˆ°å‰ç«¯

å¦‚æœPhase 0æœªè¾¾æ ‡ï¼š
- ä¸å¼€å§‹Phase 1
- ç»§ç»­å®ŒæˆPhase 0
```

---

## äº”ã€é£é™©è¯„ä¼°å®¡æ ¸

### âœ… åšå¾—å¥½çš„åœ°æ–¹

1. **é£é™©è¯†åˆ«å…¨é¢**ï¼š
   - âœ… æ–‡ä»¶ç›‘å¬å»¶è¿Ÿ
   - âœ… SQLiteå¹¶å‘å†™å†²çª
   - âœ… å¤§æ–‡ä»¶OOM
   - âœ… Socket.IOæ–­çº¿

2. **ç¼“è§£æªæ–½å…·ä½“**ï¼š
   - âœ… watchdogé™çº§åˆ°è½®è¯¢
   - âœ… WALæ¨¡å¼
   - âœ… ijsonæµå¼è§£æ

### âŒ å­˜åœ¨çš„é—®é¢˜

#### é—®é¢˜1ï¼šé£é™©é‡åŒ–ä¸è¶³

**åˆ†æå¸ˆè¯´ï¼š**
- é£é™©ï¼šé«˜/ä¸­/ä½

**å¤©æ¸…è´¨ç–‘ï¼š**
- â“ "é«˜"é£é™©çš„é‡åŒ–æ ‡å‡†æ˜¯ä»€ä¹ˆï¼Ÿ
- â“ æ¦‚ç‡æ˜¯å¤šå°‘ï¼Ÿå½±å“æœ‰å¤šå¤§ï¼Ÿ
- â“ æ²¡æœ‰é£é™©çŸ©é˜µ

**æ”¹è¿›å»ºè®®ï¼š**

```
é£é™©çŸ©é˜µï¼š
          | ä½å½±å“ | ä¸­å½±å“ | é«˜å½±å“
----------|--------|--------|--------
ä½æ¦‚ç‡    | ä½é£é™© | ä¸­é£é™© | ä¸­é£é™©
ä¸­æ¦‚ç‡    | ä¸­é£é™© | ä¸­é£é™© | é«˜é£é™©
é«˜æ¦‚ç‡    | ä¸­é£é™© | é«˜é£é™© | æé«˜é£é™©

é£é™©é‡åŒ–æ ‡å‡†ï¼š
- ä½å½±å“ï¼šç³»ç»Ÿå¯ç”¨ï¼Œç”¨æˆ·ä½“éªŒè½»å¾®ä¸‹é™
- ä¸­å½±å“ï¼šéƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨ï¼Œéœ€æ‰‹åŠ¨æ¢å¤
- é«˜å½±å“ï¼šç³»ç»Ÿä¸å¯ç”¨ï¼Œæ•°æ®ä¸¢å¤±

ä½æ¦‚ç‡ï¼š< 10%
ä¸­æ¦‚ç‡ï¼š10% - 30%
é«˜æ¦‚ç‡ï¼š> 30%
```

---

#### é—®é¢˜2ï¼šç¼ºå°‘ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

**å¤©æ¸…è®¤ä¸ºå¿…é¡»æœ‰ï¼š**

```typescript
NF-ALERT-01: ç³»ç»Ÿå‘Šè­¦
éªŒæ”¶æ ‡å‡†:
- watchdog å¤±æ•ˆ > 5åˆ†é’Ÿ â†’ å‘Šè­¦
- SQLite å†™å…¥å¤±è´¥ > 3æ¬¡ â†’ å‘Šè­¦
- API å“åº”æ—¶é—´ > 5ç§’ â†’ å‘Šè­¦
- å†…å­˜å ç”¨ > 1GB â†’ å‘Šè­¦
- ç£ç›˜ç©ºé—´ < 100MB â†’ å‘Šè­¦

å‘Šè­¦æ–¹å¼:
- Dashboard çº¢è‰²æ¨ªå¹…æç¤º
- Console æ—¥å¿— ERROR
- ï¼ˆå¯é€‰ï¼‰é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥
```

---

## å…­ã€å¤©æ¸…çš„ç»¼åˆè¯„å®¡ç»“è®º

### âœ… ä¼˜ç‚¹

1. **æ–¹æ¡ˆå®Œæ•´åº¦é«˜**ï¼š80%
   - éœ€æ±‚è¡¥å……å®Œæ•´
   - æŠ€æœ¯æ¶æ„æ¸…æ™°
   - ä»£ç ç¤ºä¾‹è¯¦ç»†

2. **è§£å†³äº†å¤©æ¸…æå‡ºçš„å¤§éƒ¨åˆ†é—®é¢˜**ï¼š70%
   - runs.jsoné™·é˜±ï¼šâœ… å·²è§£å†³
   - SQLiteç¼“å­˜ï¼šâœ… å·²è®¾è®¡
   - watchdogç›‘å¬ï¼šâœ… å·²å®ç°
   - é”™è¯¯æ¢å¤ï¼šâš ï¸ éƒ¨åˆ†è§£å†³

### âŒ é—®é¢˜

1. **æ€§èƒ½æŒ‡æ ‡ç¼ºä¹ä¾æ®**ï¼š
   - 10ä¸ªAgentã€2ç§’å“åº”ã€500MBå†…å­˜
   - å»ºè®®ï¼šå¢åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•è®¡åˆ’

2. **é”™è¯¯æ¢å¤ä¸å®Œæ•´**ï¼š
   - watchdogå¤±æ•ˆã€SQLiteæŸåã€ç£ç›˜ç©ºé—´
   - å»ºè®®ï¼šå¢åŠ å…œåº•æœºåˆ¶

3. **æ—¶é—´ä¼°ç®—è¿‡äºä¹è§‚**ï¼š
   - Phase 0ï¼š2-3å¤© â†’ 3-4å¤©
   - å»ºè®®ï¼šæ¯å¤©æ˜ç¡®äº¤ä»˜ç‰©

4. **ç¼ºå°‘ç›‘æ§å‘Šè­¦**ï¼š
   - æ²¡æœ‰å¥åº·æ£€æŸ¥ã€æ€§èƒ½ç›‘æ§ã€å‘Šè­¦æœºåˆ¶
   - å»ºè®®ï¼šå¢åŠ NF-MONITOR-01ã€NF-ALERT-01

### âš ï¸ é—æ¼çš„å…³é”®ç‚¹

1. **æ•°æ®è¿ç§»ç­–ç•¥**ï¼š
   - SQLite schemaå˜æ›´æ€ä¹ˆåŠï¼Ÿ
   - å»ºè®®ï¼šå¢åŠ NF-MIGRATION-01

2. **æ€§èƒ½ç›‘æ§**ï¼š
   - å¦‚ä½•çŸ¥é“ç³»ç»Ÿå¥åº·ï¼Ÿ
   - å»ºè®®ï¼šå¢åŠ NF-MONITOR-01

3. **å…œåº•æœºåˆ¶**ï¼š
   - watchdogå¤±æ•ˆæ€ä¹ˆåŠï¼Ÿ
   - å»ºè®®ï¼šå¢åŠ å®šæ—¶æ‰«æå¤‡ä»½

---

## ä¸ƒã€å¤©æ¸…çš„æœ€ç»ˆå»ºè®®

### ä¿®æ”¹å»ºè®®ï¼ˆå¿…é¡»ï¼‰

1. **è°ƒæ•´Phase 0æ—¶é—´**ï¼š2-3å¤© â†’ 3-4å¤©
2. **å¢åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•**ï¼šæ˜ç¡®æ€§èƒ½æŒ‡æ ‡ä¾æ®
3. **è¡¥å……é”™è¯¯æ¢å¤æœºåˆ¶**ï¼šwatchdogå¤±æ•ˆã€SQLiteæŸåã€ç£ç›˜ç©ºé—´
4. **å¢åŠ ç›‘æ§å‘Šè­¦**ï¼šå¥åº·æ£€æŸ¥ã€æ€§èƒ½ç›‘æ§ã€å‘Šè­¦
5. **å¢åŠ æ•°æ®è¿ç§»ç­–ç•¥**ï¼šschemaå˜æ›´ã€æ•°æ®å¤‡ä»½

### å®æ–½å»ºè®®

**Phase -1ï¼šæŠ€æœ¯éªŒè¯ï¼ˆ1å¤©ï¼‰** â­ å»ºè®®å¢åŠ 
- æµ‹è¯•watchdogç›‘å¬OpenClawæ–‡ä»¶
- æµ‹è¯•ijsonæµå¼è§£ææ€§èƒ½
- æµ‹è¯•SQLiteå¹¶å‘å†™å…¥æ€§èƒ½
- éªŒè¯æŠ€æœ¯å¯è¡Œæ€§

**Phase 0ï¼šåŸºç¡€æ¶æ„ï¼ˆ3-4å¤©ï¼‰**
- SQLiteç¼“å­˜å±‚ï¼ˆ1å¤©ï¼‰
- watchdogç›‘å¬å±‚ï¼ˆ1å¤©ï¼‰
- Socket.IOæ¨é€å±‚ï¼ˆ1å¤©ï¼‰
- é›†æˆæµ‹è¯•ï¼ˆ0.5-1å¤©ï¼‰

**Phase 1ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆ4-5å¤©ï¼‰**
- åŸºäºPhase 0å®ç°

---

## å…«ã€å¤©æ¸…çš„è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **éœ€æ±‚å®Œæ•´æ€§** | â­â­â­â­ (80%) | è¡¥å……äº†å¤§éƒ¨åˆ†éœ€æ±‚ï¼Œä½†æ€§èƒ½æŒ‡æ ‡ç¼ºä¾æ® |
| **æŠ€æœ¯å¯è¡Œæ€§** | â­â­â­â­â­ (90%) | SQLite+watchdogæ–¹æ¡ˆå¯è¡Œ |
| **æ¶æ„è®¾è®¡** | â­â­â­â­ (80%) | ä¸‰å±‚æ¶æ„æ¸…æ™°ï¼Œä½†ç¼ºå°‘ç›‘æ§ |
| **é£é™©è¯„ä¼°** | â­â­â­ (70%) | è¯†åˆ«äº†é£é™©ï¼Œä½†é‡åŒ–ä¸è¶³ |
| **æ—¶é—´ä¼°ç®—** | â­â­â­ (60%) | Phase 0è¿‡äºä¹è§‚ |
| **æ€»ä½“è¯„åˆ†** | â­â­â­â­ (76%) | è‰¯å¥½ï¼Œä½†éœ€è¦æ”¹è¿› |

---

**å¤©æ¸…çš„ç»“è®ºï¼š**

åˆ†æå¸ˆçš„æ–¹æ¡ˆ**æ€»ä½“å¯è¡Œ**ï¼Œä½†éœ€è¦ï¼š
1. âœ… è°ƒæ•´æ—¶é—´ä¼°ç®—ï¼ˆPhase 0ï¼š3-4å¤©ï¼‰
2. âœ… å¢åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
3. âœ… è¡¥å……é”™è¯¯æ¢å¤æœºåˆ¶
4. âœ… å¢åŠ ç›‘æ§å‘Šè­¦
5. âœ… å¢åŠ Phase -1æŠ€æœ¯éªŒè¯ï¼ˆ1å¤©ï¼‰

**å»ºè®®ï¼šå…ˆåš1å¤©æŠ€æœ¯éªŒè¯ï¼Œå†å¼€å§‹Phase 0ï¼**

---

_å®¡æ ¸ç»“æŸã€‚å¤©æ¸…è®¤çœŸå®¡æ ¸äº†ï¼Œå¸Œæœ›åˆ†æå¸ˆæ”¹è¿›ï¼_
